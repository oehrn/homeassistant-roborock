name: "Release"

on:
  release:
    types: ["published"]
  workflow_dispatch:

permissions: {}

jobs:
  release:
    runs-on: "ubuntu-latest"
    permissions:
      contents: write

    steps:
      - name: "Checkout the repository"
        uses: "actions/checkout@v4"

      - name: "Derive version (strip leading v)"
        id: version
        shell: "bash"
        run: |
          TAG="${{ github.event.release.tag_name }}"
          VERSION="${TAG#v}"
          echo "tag=$TAG" >> "$GITHUB_OUTPUT"
          echo "version=$VERSION" >> "$GITHUB_OUTPUT"
          echo "Using VERSION=$VERSION (from TAG=$TAG)"

      - name: "Adjust manifest version"
        shell: "bash"
        run: |
          python3 - <<'PY'
          import json, pathlib, os
          manifest = pathlib.Path("custom_components/roborock/manifest.json")
          data = json.loads(manifest.read_text(encoding="utf-8"))
          data["version"] = os.environ["VERSION"]
          manifest.write_text(json.dumps(data, ensure_ascii=False, indent=2) + "\n", encoding="utf-8")
          PY
        env:
          VERSION: ${{ steps.version.outputs.version }}

      - name: "Zip the integration directory"
        shell: "bash"
        run: |
          cd "${{ github.workspace }}/custom_components/roborock"
          zip -r "${{ github.workspace }}/roborock.zip" ./

      - name: "Upload ZIP to release"
        uses: "softprops/action-gh-release@v2"
        with:
          files: "roborock.zip"
