name: "Release"

on:
  release:
    types:
      - "published"
  workflow_dispatch:

permissions: {}

jobs:
  release:
    name: "Release"
    runs-on: "ubuntu-latest"
    permissions:
      contents: write
    steps:
      - name: "Checkout the repository"
        uses: "actions/checkout@v4"

      - name: "Validate tag format (no leading v, allow bN)"
        shell: "bash"
        run: |
          TAG="${{ github.event.release.tag_name }}"
          if [[ "$TAG" == v* ]]; then
            echo "ERROR: Tags must NOT start with 'v'. Use: 1.2.3 or 1.2.3b1"
            exit 1
          fi
          if [[ ! "$TAG" =~ ^[0-9]+\.[0-9]+\.[0-9]+(b[0-9]+)?$ ]]; then
            echo "ERROR: Invalid tag format: $TAG"
            echo "Expected: X.Y.Z or X.Y.ZbN (e.g. 1.0.24 or 1.0.25b1)"
            exit 1
          fi
          echo "TAG=$TAG"

      - name: "Adjust manifest version"
        shell: "bash"
        run: |
          python3 - <<'PY'
          import json, pathlib
          import os

          tag = os.environ["TAG"]
          manifest = pathlib.Path("custom_components/roborock/manifest.json")
          data = json.loads(manifest.read_text(encoding="utf-8"))
          data["version"] = tag
          manifest.write_text(json.dumps(data, ensure_ascii=False, indent=2) + "\n", encoding="utf-8")
          PY
        env:
          TAG: ${{ github.event.release.tag_name }}

      - name: "Zip the integration directory"
        shell: "bash"
        run: |
          cd "${{ github.workspace }}/custom_components/roborock"
          zip -r "${{ github.workspace }}/roborock.zip" ./

      - name: "Upload ZIP to release"
        uses: softprops/action-gh-release@v2
        with:
          files: roborock.zip
