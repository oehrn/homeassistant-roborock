name: "Release"

on:
  release:
    types: ["published"]

permissions: {}

jobs:
  release:
    name: "Build & Upload roborock.zip"
    runs-on: "ubuntu-latest"
    permissions:
      contents: write

    steps:
      - name: "Checkout"
        uses: "actions/checkout@v4"

      - name: "Set manifest version from tag"
        shell: bash
        run: |
          python - <<'PY'
          import json, os
          tag = os.environ["GITHUB_REF_NAME"]
          path = "custom_components/roborock/manifest.json"
          with open(path, "r", encoding="utf-8") as f:
            data = json.load(f)
          data["version"] = tag
          with open(path, "w", encoding="utf-8") as f:
            json.dump(data, f, ensure_ascii=False, indent=2)
            f.write("\n")
          print(f"Set manifest version to {tag}")
          PY

      - name: "Zip integration"
        shell: bash
        run: |
          cd custom_components/roborock
          zip -r roborock.zip ./

      - name: "Upload asset to release"
        uses: "softprops/action-gh-release@v2"
        with:
          files: "custom_components/roborock/roborock.zip"
